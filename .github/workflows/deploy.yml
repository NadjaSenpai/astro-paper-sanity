name: ðŸš€ Deploy to Cloudflare Pages (Docker Cache)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up QEMU (for Buildx)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver: docker-container
          buildkitd-flags: --debug

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with Docker & cache
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/amd64
          push: false
          cache-from: type=registry,ref=ghcr.io/nadjasenpai/astro-paper-sanity:buildcache
          cache-to: type=registry,ref=ghcr.io/nadjasenpai/astro-paper-sanity:buildcache,mode=max
          outputs: type=local,dest=./_cache_output

      - name: Extract build output
        run: |
          mkdir -p dist
          mkdir -p functions/api
          cp -r _cache_output/dist/* dist/
          cp -r _cache_output/functions/api/* functions/api/

      - name: Install Wrangler
        run: npm install -g wrangler@3

      - name: Deploy to Cloudflare Pages
        run: |
          wrangler pages deploy ./dist \
            --project-name astro-paper-sanity \
            --branch main \
            --functions ./functions/api
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}